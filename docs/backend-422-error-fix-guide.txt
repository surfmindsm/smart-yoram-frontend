=====================================================
ğŸš¨ ë°±ì—”ë“œ API 422 ì—ëŸ¬ í•´ê²° ê°€ì´ë“œ (ê¸´ê¸‰)
=====================================================
ì‘ì„±ì¼: 2025-01-11
ëŒ€ìƒ: ë°±ì—”ë“œ ê°œë°œì
ë¬¸ì œ: ëª¨ë“  ì±„íŒ… APIì—ì„œ 422 Unprocessable Entity ì—ëŸ¬ ë°œìƒ

=====================================================
ğŸ“‹ í˜„ì¬ ìƒí™© ìš”ì•½
=====================================================

âœ… ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸ëŠ” ì¡´ì¬í•¨ (êµ¬í˜„ ì™„ë£Œ ìƒíƒœ)
âœ… í”„ë¡ íŠ¸ì—”ë“œì—ì„œ API í˜¸ì¶œ ì‹œë„ ì¤‘
âŒ ëª¨ë“  ìš”ì²­ì—ì„œ 422 Unprocessable Entity ì—ëŸ¬ ë°œìƒ
âŒ JWT ì¸ì¦ ë¬¸ì œë¡œ ì¶”ì •ë¨

ë°œìƒí•˜ëŠ” API ì—”ë“œí¬ì¸íŠ¸:
- GET  /api/v1/chat/histories
- POST /api/v1/chat/histories  
- GET  /api/v1/chat/histories/{id}/messages
- POST /api/v1/chat/messages
- GET  /api/v1/agents

=====================================================
ğŸ”§ ìˆ˜ì •í•´ì•¼ í•  ì‚¬í•­
=====================================================

1. JWT í† í° ê²€ì¦ ë¡œì§ ìˆ˜ì •
----------------------------
í˜„ì¬ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³´ë‚´ëŠ” Authorization í—¤ë”:
Authorization: Bearer {localStorageì˜ token ê°’}

ë¬¸ì œì :
- JWT í† í° íŒŒì‹± ì‹¤íŒ¨
- í† í° ê²€ì¦ ì‹¤íŒ¨
- ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨

í•´ê²° ë°©ë²•:
- JWT í† í° ë””ì½”ë”© ë¡œì§ í™•ì¸
- í† í° ì„œëª… ê²€ì¦ í™•ì¸  
- í† í° ë§Œë£Œ ì‹œê°„ ê²€ì¦ í™•ì¸

2. ìš”ì²­ ë°”ë”” ê²€ì¦ ë¡œì§ ìˆ˜ì •
----------------------------
í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³´ë‚´ëŠ” ìš”ì²­ í˜•ì‹:

POST /api/v1/chat/messages:
{
  "chat_history_id": "string",
  "agent_id": "string", 
  "content": "string"
}

POST /api/v1/chat/histories:
{
  "agent_id": "string",
  "title": "string"
}

ë¬¸ì œì :
- í•„ìˆ˜ í•„ë“œ ê²€ì¦ ì‹¤íŒ¨
- ë°ì´í„° íƒ€ì… ê²€ì¦ ì‹¤íŒ¨
- ìš”ì²­ ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜

í•´ê²° ë°©ë²•:
- Pydantic ëª¨ë¸ ê²€ì¦ ë¡œì§ í™•ì¸
- í•„ìˆ˜ í•„ë“œ ì„¤ì • í™•ì¸
- ë°ì´í„° íƒ€ì… ë§¤í•‘ í™•ì¸

3. CORS ì„¤ì • í™•ì¸
----------------------------
í”„ë¡ íŠ¸ì—”ë“œ ë„ë©”ì¸: http://localhost:3000

í•„ìš”í•œ CORS í—¤ë”:
- Access-Control-Allow-Origin: http://localhost:3000
- Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
- Access-Control-Allow-Headers: Content-Type, Authorization

4. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
----------------------------
í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸:
- chat_histories í…Œì´ë¸”
- chat_messages í…Œì´ë¸”
- agents í…Œì´ë¸”

=====================================================
ğŸ”‘ GPT API í‚¤ ì„¤ì • (ì¤‘ìš”!)
=====================================================

OpenAI API í‚¤:
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

ì„¤ì • ë°©ë²•:
1. í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •: OPENAI_API_KEY
2. ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ church_settings í…Œì´ë¸”ì— ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
3. chat-gpt ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ì´ í‚¤ ì‚¬ìš©

GPT ì„¤ì •:
- ëª¨ë¸: gpt-3.5-turbo
- ìµœëŒ€ í† í°: 500
- Temperature: 0.7
- System Message: "ë‹¹ì‹ ì€ êµíšŒ ì‚¬ì—­ì„ ë•ëŠ” AI êµì—­ìì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”."

=====================================================
ğŸ§ª ë””ë²„ê¹… ë°©ë²•
=====================================================

1. ë¡œê·¸ í™•ì¸
----------------------------
ë‹¤ìŒ ë‚´ìš©ì„ ë¡œê·¸ì— ì¶œë ¥í•´ì£¼ì„¸ìš”:

- ë°›ì€ JWT í† í° (ì• 10ìë¦¬ë§Œ)
- íŒŒì‹±ëœ ì‚¬ìš©ì ID
- ìš”ì²­ ë°”ë”” ë‚´ìš©
- ê²€ì¦ ì‹¤íŒ¨ ì‚¬ìœ 
- DB ì¿¼ë¦¬ ê²°ê³¼

ì˜ˆì‹œ ë¡œê·¸:
```
[DEBUG] JWT Token: Bearer eyJhb...
[DEBUG] User ID: 123
[DEBUG] Request Body: {"chat_history_id": "chat-123", "content": "ì•ˆë…•í•˜ì„¸ìš”"}
[DEBUG] Validation Error: Missing required field 'agent_id'
[DEBUG] DB Query: SELECT * FROM chat_histories WHERE user_id = 123
```

2. í…ŒìŠ¤íŠ¸ ë°©ë²•
----------------------------
ë‹¤ìŒ curl ëª…ë ¹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸:

# 1. ì¸ì¦ í…ŒìŠ¤íŠ¸
curl -X GET "https://api.surfmind-team.com/api/v1/chat/histories" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"

# 2. ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸  
curl -X POST "https://api.surfmind-team.com/api/v1/chat/messages" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"chat_history_id": "1", "agent_id": "1", "content": "í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€"}'

ê¸°ëŒ€ ê²°ê³¼: 200 OK ì‘ë‹µ

=====================================================
ğŸ“ POST /api/v1/chat/messages êµ¬í˜„ ì˜ˆì‹œ
=====================================================

FastAPI êµ¬í˜„ ì˜ˆì‹œ:

```python
from openai import OpenAI

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(api_key=OPENAI_API_KEY)

@app.post("/api/v1/chat/messages")
async def send_message(
    message: ChatMessageRequest,
    current_user = Depends(get_current_user)
):
    try:
        # 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
        user_msg = await save_user_message(
            chat_history_id=message.chat_history_id,
            content=message.content,
            user_id=current_user.id
        )
        
        # 2. GPT API í˜¸ì¶œ
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {
                    "role": "system", 
                    "content": "ë‹¹ì‹ ì€ êµíšŒ ì‚¬ì—­ì„ ë•ëŠ” AI êµì—­ìì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”."
                },
                {"role": "user", "content": message.content}
            ],
            max_tokens=500,
            temperature=0.7
        )
        
        ai_content = response.choices[0].message.content
        tokens_used = response.usage.total_tokens
        cost = tokens_used * 0.0015 / 1000
        
        # 3. AI ì‘ë‹µ ì €ì¥
        ai_msg = await save_ai_message(
            chat_history_id=message.chat_history_id,
            content=ai_content,
            tokens_used=tokens_used,
            cost=cost
        )
        
        # 4. ì‘ë‹µ ë°˜í™˜
        return {
            "success": True,
            "data": {
                "user_message": {
                    "id": user_msg.id,
                    "content": user_msg.content,
                    "role": "user",
                    "timestamp": user_msg.created_at
                },
                "ai_response": {
                    "id": ai_msg.id,
                    "content": ai_msg.content,
                    "role": "assistant", 
                    "timestamp": ai_msg.created_at,
                    "tokensUsed": tokens_used,
                    "cost": cost
                }
            }
        }
        
    except Exception as e:
        logger.error(f"Chat message error: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))
```

=====================================================
ğŸ¯ ìš°ì„ ìˆœìœ„ ì‘ì—…
=====================================================

1. â­ ìµœìš°ì„ : JWT í† í° ê²€ì¦ ë¡œì§ ìˆ˜ì •
   - 422 ì—ëŸ¬ì˜ ì£¼ìš” ì›ì¸ìœ¼ë¡œ ì¶”ì •ë¨
   - í† í° íŒŒì‹± ë° ì‚¬ìš©ì ì¸ì¦ í™•ì¸

2. â­ ë†’ìŒ: OpenAI API í‚¤ ì„¤ì •
   - í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY ì„¤ì •
   - GPT ì—°ë™ ë¡œì§ êµ¬í˜„

3. â­ ì¤‘ê°„: ìš”ì²­ ê²€ì¦ ë¡œì§ ì ê²€
   - Pydantic ëª¨ë¸ í™•ì¸
   - í•„ìˆ˜ í•„ë“œ ê²€ì¦

4. â­ ë‚®ìŒ: CORS ì„¤ì • ì ê²€
   - localhost:3000 í—ˆìš© í™•ì¸

=====================================================
ğŸ“ ì—°ë½ì²˜
=====================================================

ë¬¸ì œ í•´ê²° í›„ ë‹¤ìŒ ì‚¬í•­ í™•ì¸:
1. ë¸Œë¼ìš°ì €ì—ì„œ ìƒˆ ëŒ€í™” ì‹œì‘ ê°€ëŠ¥
2. ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì‹¤ì œ GPT ì‘ë‹µ ìˆ˜ì‹ 
3. ì½˜ì†”ì—ì„œ 200 OK ì‘ë‹µ í™•ì¸
4. ë” ì´ìƒ 422 ì—ëŸ¬ ì—†ìŒ

ì¶”ê°€ ì§ˆë¬¸ì´ë‚˜ ë„ì›€ì´ í•„ìš”í•˜ë©´ ì—°ë½ ì£¼ì„¸ìš”.

=====================================================
